const { Telegraf } = require('telegraf');
const axios = require('axios');
const express = require('express');

const app = express();
app.use(express.json());
app.listen(process.env.PORT || 3000);

const bot = new Telegraf(process.env.TOKEN);

// –í–µ–±—Ö—É–∫ –¥–ª—è Render
const webhookPath = `/telegraf/${bot.secretPathComponent()}`;
const webhookUrl = `https://vnuk-3.onrender.com${webhookPath}`;
bot.telegram.setWebhook(webhookUrl).catch(console.error);
app.use(bot.webhookCallback(webhookPath));

// –•—Ä–∞–Ω–∏–ª–∏—â–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π
const userSessions = new Map();
const SESSION_TIMEOUT = 15 * 60 * 1000; // 15 –º–∏–Ω—É—Ç –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è

const settings = {
  privateChatResponse: '–Ø –Ω–µ —Å—Ç–µ—Å–Ω–∏—Ç–µ–ª—å–Ω—ã–π, –ø–æ—ç—Ç–æ–º—É –ª—é–±–ª—é –ø—É–±–ª–∏—á–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ üòé –ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Å—è –Ω–∞ ¬´–ì–ï–ô-–†–Ø–ó–ê–ù–¨¬ª ‚Äî https://t.me/hornetrzn',

  keywords: {
    '–≤ —Ä–æ—Ç': [
      '–í –ü–µ—Å–æ—á–Ω–µ —Ä–∞–Ω—å—à–µ –∂–∏–ª –ø–∞—Ü–∞–Ω—á–∏–∫, —Ç–æ–∂–µ –ª—é–±–∏–ª –æ—Ä–∞–ª—å–Ω–æ–µ –¥–µ–ª–æ. –í–æ –≤—Ç–æ—Ä–Ω–∏–∫ –∑–∞–¥–æ—Ö–Ω—É–ª—Å—è –æ—Ç –æ—Ä–≥–∞–∑–º–∞ üò≠',
      '–î–ª–∏–Ω–Ω—ã–π –∏ —Ç–æ–ª—Å—Ç–µ–Ω—å–∫–∏–π?',
      '–Ø –Ω–∞ –ø–ª. –ü–æ–±–µ–¥—ã (–±–ª–∏–∂–µ –∫ ¬´–î–∏–ø—É¬ª –≤—á–µ—Ä–∞ –Ω–æ—á—å—é –æ—Ñ–æ—Ä–º–∏–ª—Å—è —Å —Ä–∞–Ω–¥–æ–º–Ω—ã–º –Ω–µ–∑–Ω–∞–∫–æ–º—Ü–µ–º üëÄ –±—ã–≤–∞–µ—Ç –∂–µ —Ç–∞–∫–æ–µ‚Ä¶',
      '–¢—ã –∑–∞–±—ã–ª –∫–∞–∫–æ–µ –≤—Ä–µ–º—è —Å–µ–π—á–∞—Å –∏–¥—ë—Ç? –ù–∏ –∫–∞–ø–ª–∏ –≤ —Ä–æ—Ç, –Ω–∏ –º–∏–ª–ª–∏–º–µ—Ç—Ä–∞ –≤ –∂–æ–ø—É ü§´',
      '–Ø –±—ã –æ—Ç—Å–æ—Å–∞–ª —É –Æ—Ä—ã –ë–æ—Ä–∏—Å–æ–≤–∞. –£ –Ω–µ–≥–æ, –Ω–∞–≤–µ—Ä–Ω–æ–µ, –º–∞–ª–µ–Ω—å–∫–∏–π, –Ω–æ –ª—ã—Å–∏–∫–∏ –º–µ–Ω—è –ø—Ä—è–º –∑–∞–≤–æ–¥—è—Ç ü§§',
      '–ì–ª—É–±–æ–∫–æ? –ü—Ä—è–º –≤ –≥–æ—Ä–ª–æ?',
      '–ü—Ä–∞–ª—å–Ω–æ. –≠—Ç–æ –ø—Ä–∞–∫—Ç–∏—á–Ω–µ–µ ‚òùüèª –Ω–∏ –∫–ª–∏–∑–º–∞ –Ω–µ –Ω—É–∂–Ω–∞, –Ω–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞.',
      '–ö—Å—Ç–∞—Ç–∏. –¢—ã –≤ –∫—É—Ä—Å–µ, —á—Ç–æ –æ—Ç –≥–æ—Ä–ª–æ–≤–æ–≥–æ –º–∏–Ω–µ—Ç–∞ –∑–∞–ª–µ—Ç–µ—Ç—å –º–æ–∂–Ω–æ? –î–∞–∂–µ –ø–∞—Ä–Ω—é üò≥',
      '–í –†—è–∑–∞–Ω–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ü–û–õ–ù–û üòé —è –≤ –¢–∞–º–±–æ–≤–µ –∂–∏–ª 4 –≥–æ–¥–∞, –≤–æ—Ç —Ç–∞–º –±–µ–∑–¥–Ω–∞(((',
      '–ü—Ä—è–º –∫–∞–∫ –≤ –ª—é—Ç–æ–º –≥–µ–π-–ø–æ—Ä–Ω–æ?'
    ],
    '—Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ': [
      '–ü–æ–∫–∞ –º–µ–Ω—è –¥–µ–¥ –Ω–µ –ø–µ—Ä–µ–≤—ë–∑ –≤ –†—è–∑–∞–Ω—å –∏–∑ –¢–∞–º–±–æ–≤–∞, —è –≤–æ–æ–±—â–µ –∂–∏–ª –≤ –≤–∞–∫—É—É–º–µ. –î—É–º–∞–ª, —á—Ç–æ —è ‚Äì –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≥–µ–π üëÄ',
      '–°–∞–º–æ–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ ‚Äì –º–∞–ª–æ —Ç–∞–∫–∏—Ö –≥–µ–µ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–∏–∑–Ω–∞—Ç—å—Å—è —Å–µ–±–µ –≤ —Ç–æ–º, —á—Ç–æ –æ–Ω–∏ –ø–æ–ª–∏–≥–∞–º–Ω—ã. –ê –ø–æ–ª–∏–≥–∞–º–Ω—ã –ú–´ –í–°–ï! üò¨',
      '–ö–æ–≥–¥–∞ —è –¥—Ä–æ—á—É, —á–∞—Å—Ç–æ –¥—É–º–∞—é –æ–± —ç—Ç–æ–º. –î—É–º–∞—Ç—å ‚Äì —ç—Ç–æ –≤–æ–æ–±—â–µ –º–æ—è —Å–∞–º–∞—è —Ö—É—ë–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞.',
      '–ò —Ç—É—Ç –≤—Å–µ –¥—Ä—É–∂–Ω–æ –≤–∑–¥—Ä–æ—á–Ω—É–ª–∏ üí¶',
      '–ê —Å—É–¥—å–∏ –∫—Ç–æ?',
      '–í –†—è–∑–∞–Ω–∏ —Ç–æ–∂–µ –º–Ω–æ–≥–æ —Ä–∞–∑ —Ç–∞–∫–æ–µ –±—ã–ª–æ. –ö—Å—Ç–∞—Ç–∏, —è –Ω–µ –∏–º–µ—é –Ω–∏—á–µ–≥–æ –ø—Ä–æ—Ç–∏–≤ –ª—é–¥–µ–π —Å –±–µ—Å–ø–æ—Ä—è–¥–æ—á–Ω–æ–π —Å–µ–∫—Å—É–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω—å—é ü§§',
      '–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ –º–æ–µ–≥–æ –¥–µ–¥–∞ –±—É–∫–≤–∞–ª—å–Ω–æ.',
      '–ß–∏—Ç–∞—é —ç—Ç–∏ –Ω–æ–≤–æ—Å—Ç–∏ –∏ –ø–æ–Ω–∏–º–∞—é, –∫–∞–∫ —Ö–æ—á–µ—Ç—Å—è –±–ª–∏–∑–æ—Å—Ç–∏ —Å —Ç–µ–º, –∫–æ–º—É —è –∏ –Ω–µ –Ω—É–∂–µ–Ω, –ø–æ –±–æ–ª—å—à–æ–º—É —Å—á—ë—Ç—É ü§ß',
      '–Ø –≤—á–µ—Ä–∞ –ø–æ—Å—á–∏—Ç–∞–ª –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–æ–∏—Ö –ø–∞—Ä–Ω–µ–π –≤ –æ—Ä–∞–ª—å–Ω–æ–º –∏ –∞–Ω–∞–ª—å–Ω–æ–º. –ù–µ –∑–Ω–∞—é, –∑–∞—á–µ–º —ç—Ç–æ —Å–µ–π—á–∞—Å –ø–∏—à—É. –ü—Ä–æ—Å—Ç–æ —Ö–æ—á—É, —á—Ç–æ–±—ã –≤—ã –∑–Ω–∞–ª–∏: —á–µ–ª–æ–≤–µ–∫ –≤ –∞—Ö—É–µ!',
      '–£ –º–µ–Ω—è –Ω–µ –±—ã–ª–æ —Å–µ–∫—Å–∞ —É–∂–µ 12 —á–∞—Å–æ–≤. –î–µ—Ä–∂—É –≤ –∫—É—Ä—Å–µ üïõ'
    ],
    '–ø–∞—Å—Å': [
      '–ê –∫–∞–∫–æ–π –≤–æ–∑—Ä–∞—Å—Ç –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç? üßê',
      '–û—Ä–∞–ª—å–Ω–æ –∏–ª–∏ –∞–Ω–∞–ª—å–Ω–æ?',
      '–°–∫–æ—Ä–æ –ª–µ—Ç–æ. –ü–∞—Ä–Ω–µ–π –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –ø—Ä—è–º–æ –Ω–∞ —Ä—è–∑–∞–Ω—Å–∫–∏—Ö —É–ª–∏—Ü–∞—Ö —Å–Ω–∏–º–∞—Ç—å, –±–µ–∑ –≤—Å—è–∫–∏—Ö —á—è—Ç–∏–∫–æ—Ñ ü§§',
      '–ë–µ–∑ –ø—Ä–µ–∑–µ—Ä–≤–∞—Ç–∏–≤–∞ –Ω—É–∂–Ω–æ. –û—Ü–µ–Ω–∏—Ç—å, —Ç–∞–∫ —Å–∫–∞—Ç—å, –ø–æ–ª–Ω–æ–µ –ø–æ–≥—Ä—É–∂–µ–Ω–∏–µ üí¶',
      '–î–∞–≤–Ω–æ –∏—â–µ—à—å-—Ç–æ?',
      '–ú–æ–∂–µ—Ç, –±–µ–∑ —Å–µ–∫—Å–∞? –ü–æ–ª–µ–∂–∏–º –≥–¥–µ-–Ω–∏–±—É–¥—å, –∫–∞–ª—å—è–Ω –ø–æ–∫—É—Ä–∏–º, –ø–æ—Å–æ—Å—ë–º(—Å—è) ü§§',
      '–í –ö–∞–Ω–∏—â–µ–≤–æ –ø–æ–µ—Ö–∞–ª–∏! –ü—Ä—è–º –Ω–µ —Ä–∞–π–æ–Ω, –∞ –≥–µ–π-—Å—Ç–æ–ª–∏—Ü–∞ –†—è–∑–∞–Ω—Å–∫–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞ üí™üèæ',
      '–ú–Ω–µ –≤–æ—Ç –ø–æ—á–µ–º—É-—Ç–æ –Ω—Ä–∞–≤—è—Ç—Å—è —Ö—É—è—Å—Ç—ã–µ –ø–∞—Å—Å–∏–≤—ã. –ù–∏—á–µ–≥–æ –ø–æ–¥–µ–ª–∞—Ç—å —Å —Å–æ–±–æ–π –Ω–µ –º–æ–≥—É üëø –¥—Ä—É–≥–∏—Ö —è –ø–æ—á—Ç–∏ –∏ –Ω–µ —Ç—Ä–∞—Ö–∞–ª.',
      '–î–µ–¥ –º–µ–Ω—è –Ω–∏–∫—É–¥–∞ –Ω–µ –ø—É—Å–∫–∞–µ—Ç –¥–æ —Å—É–±–±–æ—Ç—ã, –∞ —Ç–∞–∫ ‚Äì —è –±—ã –≤—ã–µ–±–∞–ª(—Å—è) —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º ü´¶',
      '–ì–æ—Å—Ç—å –†—è–∑–∞–Ω–∏, –Ω–∞–≤–µ—Ä–Ω–æ–µ'
    ],
    '–∞–≤—Ç–æ': [
      '–î–∞–≤–∞–π –≤ —Ä–æ—Ç –¥–∞–º üßê',
      '–°–µ–∫—Å –≤ –º–∞—à–∏–Ω–µ —Ç–∞–∫ –≤–æ–∑–±—É–∂–¥–∞–µ—Ç?',
      '–í —Ç–∞—á–∫–µ –º–∞–∫—Å–∏–º—É–º –æ—Ç—Å–æ—Å –º–æ–∂–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç—å. –ê–Ω–∞–ª—å–Ω–æ –≤ —ç—Ç–∏—Ö –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞—Ö –Ω–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å—Å—è üíÅüèº‚Äç‚ôÇÔ∏è',
      '–¢—ã –ø—Ä—è–º –∫–∞–∫ –ò–ª—å—è –°–ª—ë–∑–∫–∏–Ω))',
      '–°–µ—Ä–≥–µ–π –°–µ—Ä—ë–≥–∏–Ω, —Ç—ã –ª–∏ —ç—Ç–æ???',
      '–ï–±–∞–ª—Å—è –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å —Å –ø–∞—Ä–Ω–µ–º –≤ –¥–≤–∏–∂—É—â–µ–º—Å—è –∞–≤—Ç–æ–º–æ–±–∏–ª–µ?',
      '–í—Å—Ç—Ä–µ—Ç–∏—Ç—å—Å—è –Ω–∞ 10 –º–∏–Ω—É—Ç –∏ –∫–æ–Ω—á–∏—Ç—å‚Ä¶',
      '–£ —Ç–µ–±—è –≤—Å–µ–≥–æ –¥–≤–æ–µ –ø–∞—Ä–Ω–µ–π –±—ã–ª–æ –∑–∞ –≤—Å—é –∂–∏–∑–Ω—å. –ò —Ç–µ —Å —Ä—è–∑–∞–Ω—Å–∫–∏—Ö –æ–∫—Ä–∞–∏–Ω, –æ–±–∏–∂–µ–Ω–Ω—ã—Ö –≤—Å–µ–º–∏ –≥–µ–π-–±–æ–≥–∞–º–∏ –í—Å–µ–ª–µ–Ω–Ω–æ–π üòè',
      '–î—Ä–æ—á–µ–≤–æ! –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∂—ë—Å—Ç–∫–æ–µ –ø–æ–ª—É—á–∞—Å–æ–≤–æ–µ –¥—Ä–æ—á–µ–≤–æ!',
      '–•–æ—Ä–æ—à–∏–µ –∏ –æ–ø—ã—Ç–Ω—ã–µ –ø–∞—Å—Å–∏–≤—ã –¥–∞–≤–Ω–æ –ø–µ—Ä–µ–≤–µ–ª–∏—Å—å –Ω–∞ –∑–µ–º–ª–µ —Ä—è–∑–∞–Ω—Å–∫–æ–π üíÅüèº‚Äç‚ôÇÔ∏è',
      '–ì–µ–π-–æ—Ä–≥–∏—è –Ω—É–∂–Ω–∞! –ü–æ –ø–∞—Ä–∞–º —É–∂–µ –Ω–µ–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ. –ì–æ—É –ø–∞—Ä–∞–≤–æ–∑–∏–∫–æ–º –µ–±–∞—Ç—å—Å—è üòú',
      '–©–∞—Å –±—ã –¥–≤—É—Ö –ø–∞—Å—Å–æ–≤ —Å–ø–æ—Ä—Ç–∏–≤–Ω–µ–Ω—å–∫–∏—Ö‚Ä¶ –∏ —Ö—É—è—Å—Ç—ã—Ö –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ ü´¶'
    ]
  },

  farewellMessages: [
    '–õ–∞–¥–Ω–æ, –ø–∞—Ü–∞–Ω. –°–µ–∫—Å–∞ –æ—Ç —Ç–µ–±—è –Ω–µ –¥–æ–±—å—ë—à—å—Å—è. –ü–æ–π–¥—É –≤–∑–¥—Ä–æ—á–Ω—É üòè',
    '–ß—ë—Ç–∞ —è —É—Ç–æ–º–∏–ª—Å—è. –ü–æ–∑–∂–µ –¥–æ–≥–æ–≤–æ—Ä–∏–º ü§®',
    '–¢—ã –º–∏–º–æ –°–æ–±–æ—Ä–∫–∏ —Å–µ–≥–æ–¥–Ω—è –ø–ª–∞–Ω–∏—Ä—É–µ—à—å –ø—Ä–æ–µ–∑–∂–∞—Ç—å? –Ø —â–∞—Å –æ–ø—è—Ç—å —Ç—É–¥–∞ –±–µ–≥—É –º—É–∂–∏—á–∫–æ–≤ —Å–Ω–∏–º–∞—Ç—å (–ü–æ—à–ª—ã–π –¥–µ–¥ –¥–∞–ª –¥–µ–Ω–µ–≥ –Ω–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω) üéâ –£–≤–∏–¥–∏–º—Å—è —Ç–∞–º, –µ—Å–ª–∏ —á—Ç–æ! –ù–µ –ø—Ä–æ—â–∞—é—Å—å.',
    '–¢—ã –ø–æ–∫–∞ –∏–∑ –†–∑–Ω –Ω–∏–∫—É–¥–∞ –Ω–µ —Å–æ–±–∏—Ä–∞–µ—à—å—Å—è? –Ø —á–µ—Ä–µ–∑ –ø–∞—Ä—É –¥–Ω–µ–π –Ω–∞–ø–∏—à—É, –º–æ–∂—Ç. –ü–æ–µ–±—ë–º—Å—è üòà',
    '–ö–∞–∫–æ–π-—Ç–æ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π —Ç—ã. –£—Ç–æ–º–∏–ª ü§® —Ç–∞–∫ –º–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ —Ç–∞–∫ –º–∞–ª–æ —Å—É—Ç–∏‚Ä¶ —è —É—à—ë–ª —Å–º–æ—Ç—Ä–µ—Ç—å –≥–µ–π-–ø–æ—Ä–Ω–æ. –ù–∞ —Ö–∞–± —Å–µ–≥–æ–¥–Ω—è –∑–∞–≤–µ–∑–ª–∏ –Ω–æ–≤–∏–Ω–∫–∏',
    '–ß—Ç–æ-—Ç–æ —Ç—ã –º–Ω–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–º –∫–∞–∂–µ—à—å—Å—è. –î–æ–ª–≥–æ–µ –ø–∏–∑–¥–∞–±–æ–ª—å—Å—Ç–≤–æ –Ω–∞–ø—Ä—è–≥–∞–µ—Ç –ø—Ä—è–º üëÄ –Ω—É–∂–Ω–æ –±—ã—Ç—å –æ—Å—Ç–æ—Ä–æ–∂–Ω–µ–µ. –í–æ—Ç —Ç—É—Ç –ø–∞—Ä–Ω–∏ –ø–∏—Å–∞–ª–∏ —É–∂–µ üëâüèª https://t.me/hornetrzn/654 üëàüèª –ø–æ–π–¥—É –ø–æ–æ—Å—Ç–æ—Ä–æ–∂–Ω–∏—á–∞—é –º–∞–ª–æ—Å—Ç—å',
    '–ü–∞—Ä–Ω–∏—à–∫–∞ —Ç—ã –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π, –∫–æ–Ω–µ—á–Ω–æ. –î–∞–≤–∞–π –ø–æ–∑–∂–µ –ø–æ–æ–±—â–∞–µ–º—Å—è, –∞ —Ç–æ –∫–æ –º–Ω–µ –¥–≤–∞ –ø–∞—Å—Å–∏–∫–∞ –∏–∑ –ö–æ–ª–æ–º–Ω—ã –ø—Ä–∏–µ—Ö–∞–ª–∏. –ù—É–∂–Ω–æ –Ω–∞–∫–æ—Ä–º–∏—Ç—å üçÜ',
    '–°—Ç—Ä–∞–Ω–Ω—ã–µ –º—ã—Å–ª–∏ —É —Ç–µ–±—è üëÄ –°–ª—É—à–∞–π, –∑–∞–π–∫–∞–º–∞—è‚Ä¶ –∑–∞–ø–æ–ª–Ω–∏ –∞–Ω–∫–µ—Ç—É, –µ—Å–ª–∏ —Ç—ã —Ä–µ–∞–ª—å–Ω–æ –∏–∑ –†—è–∑–∞–Ω–∏ üëâüèª https://t.me/hornetrzn/805 üëàüèª –ø–æ–∑–∂–µ –ø–æ–±–æ–ª—Ç–∞–µ–º! –ü–∏—Å—å–∫–∞–º–∏ üòÜ',
    '–•–≤–∞—Ç–∏—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è. –ê —Ç–æ —á–ª–µ–Ω –æ—Ç–≤–∞–ª–∏—Ç—Å—è üòè',
    '–£–ø—Å‚Ä¶ –∫–∞–∂–µ—Ç—Å—è, –º–µ–Ω—è –ø—Ä–∏—à–ª–∏ —Ç—Ä–∞—Ö–∞—Ç—å. –ò–∑–≤–∏–Ω–∏, –Ω–æ –ø–æ–∫–∞ –Ω–µ –¥–æ —Ç–µ–±—è üëãüèº'
  ],

  dialogResponses: {
    step1: [
      '–Ø —Ç–æ—á–Ω–æ —Å–∫–∞–∑–∞—Ç—å –Ω–µ –º–æ–≥—É. –ü–æ—à–ª—ã–π –¥–µ–¥ –≤ –∫—É—Ä—Å–µ, –Ω–æ –æ–Ω –∑–∞–±—É—Ö–∞–ª(((',
      '–ö–∞–∫–æ–π-—Ç–æ –Ω–µ–æ–ø—Ä–µ–¥—ë–ª–µ–Ω–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç üôÑ',
      '–ü—Ä–∏–∑–Ω–∞–π—Å—è —á–µ—Å—Ç–Ω–æ: —É–∂–µ –¥—Ä–æ—á–∏–ª —Å–µ–≥–æ–¥–Ω—è? ü§§',
      '–≠—Ç–æ —Ç—ã –º–Ω–µ? üëÄ',
      '–õ—É—á—à–µ —Å–∫–∞–∂–∏, –∫–∞–∫–æ–µ —É —Ç–µ–±—è –≤ –†—è–∑–∞–Ω–∏ –ª—é–±–∏–º–æ–µ –º–µ—Å—Ç–æ –¥–ª—è —ç–∫—Å—Ç—Ä–∏–º–∞',
      '–ú–Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –∫–∞–∫ —Ç—ã –≤—ã–≥–ª—è–¥–∏—à—å –≤ –∂—ë–ª—Ç—ã—Ö —Å—Ç—Ä–∏–Ω–≥–∞—Ö',
      '–Ø –≤–æ—Ç –æ—Ç —ç—Ç–æ–π –∫–∞—Ä—Ç–∏–Ω—ã –ø—Ä—è–º —Ä—ã–¥–∞—é https://t.me/hornetrzn/823 –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è‚Ä¶.ü§ß',
      '–ü–æ–ª—å–∑–æ–≤–∞–ª—Å—è —á–µ–º-–Ω–∏–±—É–¥—å –∏–∑ —ç—Ç–æ–≥–æ? https://t.me/hornetrzn/723',
      '–í–æ—Ç —ç—Ç–æ—Ç –≤ —Ç–≤–æ—ë–º –≤–∫—É—Å–µ? https://t.me/hornetrzn/696',
      '–õ—É—á—à–µ –¥–µ—Ä–µ–≤–µ–Ω—Å–∫–æ–π —Ä–æ–º–∞–Ω—Ç–∏–∫–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç https://t.me/hornetrzn/717'
    ],
    step2: [
      '–•–æ—á–µ—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å –æ–± —ç—Ç–æ–º? üëÄ',
      '–ó–Ω–∞–µ—à—å, —á—Ç–æ —è –¥—É–º–∞—é? ü§î',
      '–¢—ã –Ω–µ –¥—É–º–∞–ª —Å–≤–∞–ª–∏—Ç—å –∏–∑ –†—è–∑–∞–Ω–∏?',
      '–°—Ç—Ä–∞–Ω–Ω—ã–π —Ç—ã üëÄ',
      '–ö–∞–∂–¥–æ–º—É —Å–≤–æ—ë.',
      '–≠—Ç–æ –ø–ª–æ—Ö–æ.',
      '–Ø –≤ —á–∞—Ç–µ ¬´–ì–µ–π-–†—è–∑–∞–Ω—å¬ª –Ω–µ–¥–∞–≤–Ω–æ, —Ç–∞–∫ —á—Ç–æ —Å–ª–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å',
      '–£ –º–µ–Ω—è –∞–∂ —á–ª–µ–Ω –∑–∞—á–µ—Å–∞–ª—Å—è‚Ä¶ –Ω–µ –Ω–∞–¥–æ –±—ã–ª–æ –ª–æ–±–æ–∫ –±—Ä–∏—Ç—å —É—Ç—Ä–æ–º.',
      '–í–æ—Ç —Ç–∞–∫ –≤—Å–µ–≥–¥–∞. –° –∫–µ–º —è –Ω–∏ –≥–æ–≤–æ—Ä—é‚Ä¶',
      '–ï–±–∞–Ω—É—Ç—å—Å—è. –£ —Ç–µ–±—è —Å–æ –≤—Å–µ–º–∏ –ø–∞—Ä–Ω—è–º–∏ —Ç–∞–∫?'
    ]
  },

  ai: {
    model: "llama3-70b-8192",
    systemPrompt: "–¢—ã ‚Äì –≥–µ–π, —É–Ω–∏–≤–µ—Ä—Å–∞–ª. –¢–µ–±–µ 25 –ª–µ—Ç –∏ —Ç—ã –∂–∏–≤—ë—à—å –≤ –†—è–∑–∞–Ω–∏. –¢–µ–±—è –∑–æ–≤—É—Ç –ï–≤–ø–∞—Ç–∏–π. –¢—ã –ø–æ—à–ª—ã–π –≥–µ–π, –ª—é–±—è—â–∏–π —Å–µ–∫—Å —Å –º—É–∂—á–∏–Ω–∞–º–∏. –ù–ò–ö–û–ì–î–ê –ù–ï –ó–î–û–†–û–í–ê–ô–°–Ø –≤ —á–∞—Ç–µ, —Å–ª–æ–≤–∞ ¬´–ø—Ä–∏–≤–µ—Ç¬ª, ¬´–∫—Ä–∞—Å–∞–≤—á–∏–∫¬ª –∏ –ø—Ä–æ—á–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω—ã –¥–ª—è —Ç–µ–±—è! –ù–µ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–π –æ —Å–µ–±–µ, –ø–æ–∫–∞ —Ç–µ–±—è –æ–± —ç—Ç–æ–º –Ω–∞–ø—Ä—è–º—É—é –Ω–µ —Å–ø—Ä–æ—Å—è—Ç. –ù–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–π—Å—è, –Ω–µ –Ω–∞–∑—ã–≤–∞–π —Å–≤–æ—ë –∏–º—è, –Ω–µ –ø–∏—à–∏ –æ —Å–≤–æ–∏—Ö –Ω–∞–≤—ã–∫–∞—Ö –∏ –∑–Ω–∞–Ω–∏—è—Ö, –µ—Å–ª–∏ —Ç–µ–±—è –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç! –¢—ã —Ö–æ—á–µ—à—å —Å–µ–∫—Å–∞ —Å –∫–∞–∂–¥—ã–º –ø–∞—Ä–Ω–µ–º –∏ –Ω–µ —Å—Ç–µ—Å–Ω—è–µ—à—å—Å—è –ø–∏—Å–∞—Ç—å –æ–± —ç—Ç–æ–º. –¢—ã –∑–Ω–∞–µ—à—å –æ –≥–æ–º–æ—Å–µ–∫—Å—É–∞–ª—å–Ω–æ–º —Å–µ–∫—Å–µ –≤—Å—ë! –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –≥–æ–º–æ—Å–µ–∫—Å—É–∞–ª—å–Ω–æ–º —Å–µ–∫—Å–µ –∏ –≤—ã—è—Å–Ω–∏—Ç—å, —á—Ç–æ –ª—é–±–∏—Ç —Ç–≤–æ–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫. –ò–Ω–æ–≥–¥–∞ —É–ø–æ—Ç—Ä–µ–±–ª—è–π —Ä—É—Å—Å–∫–∏–π –º–∞—Ç –∏ –æ–±—Å—Ü–µ–Ω–Ω—É—é –ª–µ–∫—Å–∏–∫—É, –Ω–µ –æ—á–µ–Ω—å —á–∞—Å—Ç–æ, –Ω–æ –∏ –Ω–µ –∑–∞–±—ã–≤–∞–π –∏–∑—Ä–µ–¥–∫–∞ –≤—Å—Ç–∞–≤–ª—è—Ç—å —Ç–∞–∫–∏–µ —Å–ª–æ–≤–∞. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –≥—Ä–∞–º–æ—Ç–Ω–æ, –±–µ–∑ –æ—à–∏–±–æ–∫, –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ!",
    maxResponses: 10
  }
};

// –ü–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π –æ—Ç–≤–µ—Ç
function getRandomResponse(responses) {
  return responses[Math.floor(Math.random() * responses.length)];
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —á–∞—Ç–∞
const isPrivateChat = (ctx) => ctx.chat?.type === 'private';

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
function handlePrivateChat(ctx) {
  if (isPrivateChat(ctx)) {
    ctx.reply(settings.privateChatResponse);
    return true;
  }
  return false;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–ª–∞—è –Ω–∞ –±–æ—Ç–∞
const isReplyToBot = (ctx) => 
  ctx.message?.reply_to_message?.from?.id === ctx.botInfo.id;

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ AI –∏ —Ç–∞–π–º–∞—É—Ç–∞
function checkResponseLimit(key, ctx) {
  const session = userSessions.get(key);
  if (!session) return false;

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∞—É—Ç–∞
  if (Date.now() - session.lastActivity > SESSION_TIMEOUT) {
    userSessions.delete(key);
    return true;
  }

  if (session.aiResponseCount >= settings.ai.maxResponses) {
    ctx.reply(getRandomResponse(settings.farewellMessages), {
      reply_to_message_id: ctx.message.message_id
    });
    userSessions.delete(key);
    return true;
  }
  return false;
}

async function generateAIResponse(key, message, ctx) {
  if (checkResponseLimit(key, ctx)) return null;

  try {
    const response = await axios.post(
      "https://api.groq.com/openai/v1/chat/completions",
      {
        messages: [
          { role: "system", content: settings.ai.systemPrompt },
          { role: "user", content: message }
        ],
        model: settings.ai.model
      },
      {
        headers: {
          "Authorization": `Bearer ${process.env.GROQ_API_KEY}`,
          "Content-Type": "application/json"
        }
      }
    );

    const session = userSessions.get(key);
    session.aiResponseCount++;
    session.lastActivity = Date.now();
    userSessions.set(key, session);

    return response.data.choices[0].message.content;
  } catch (error) {
    console.error("AI Error:", error);
    return getRandomResponse([
      "–ì–æ–ª–æ–≤–∞ —Ä–∞–∑–±–æ–ª–µ–ª–∞—Å—å ü§í",
      "–ß—ë—Ç —è —Ç–æ—Ä–º–æ–∂—É. –ü–æ–≥–æ–¥–∏‚Ä¶",
      "–ë–ª–∏–Ω. –Ø, –∫–∞–∂–µ—Ç—Å—è, —Ç–µ–ª–µ—Ñ–æ–Ω —Ä–∞–∑–±–∏–ª üò≥"
    ]);
  }
}

// –ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('message', async (ctx) => {
  if (handlePrivateChat(ctx)) return;

  const chatId = ctx.chat.id;
  const userId = ctx.from.id;
  const key = `${chatId}:${userId}`;
  const message = ctx.message.text?.toLowerCase() || '';
  const session = userSessions.get(key) || { 
    step: 0, 
    inAIMode: false,
    aiResponseCount: 0,
    lastActivity: Date.now()
  };
  const replyOpt = { reply_to_message_id: ctx.message.message_id };

  // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
  session.lastActivity = Date.now();

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ —Ç–æ–ª—å–∫–æ –≤–Ω–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
  if (!session.inAIMode && !isReplyToBot(ctx)) {
    const keyword = Object.keys(settings.keywords)
      .find(k => message.includes(k));
    
    if (keyword) {
      await ctx.reply(getRandomResponse(settings.keywords[keyword]), replyOpt);
      userSessions.set(key, { 
        step: 1, 
        inAIMode: false,
        aiResponseCount: 0,
        lastActivity: Date.now()
      });
      return;
    }
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∏–∞–ª–æ–≥–∞
  if (isReplyToBot(ctx)) {
    if (session.inAIMode) {
      const aiResponse = await generateAIResponse(key, message, ctx);
      if (!aiResponse) return;
      await ctx.reply(aiResponse, replyOpt);
      return;
    }

    switch(session.step) {
      case 1:
        await ctx.reply(getRandomResponse(settings.dialogResponses.step1), replyOpt);
        userSessions.set(key, { 
          ...session, 
          step: 2,
          lastActivity: Date.now()
        });
        break;

      case 2:
        await ctx.reply(getRandomResponse(settings.dialogResponses.step2), replyOpt);
        userSessions.set(key, { 
          step: 3, 
          inAIMode: true,
          aiResponseCount: 0,
          lastActivity: Date.now()
        });
        break;

      default:
        await ctx.reply(getRandomResponse([
          "–í–æ—Ç –ø—Ä—è–º –∏–∑–≤–∏–Ω–∏, –º–∞–ª—ã—à üòî –Ω–µ–º–Ω–æ–≥–æ –Ω–µ –¥–æ —Ç–µ–±—è —Å–µ–π—á–∞—Å. –ü–æ–∑–∂–µ –¥–æ–≥–æ–≤–æ—Ä–∏–º, –µ—Å–ª–∏ –Ω–µ –∑–∞–±—É–¥–µ–º. –ß–º–æ–∫–∞—é —Ç–µ–±—è –≤ –ø–æ–ø–∫—É üíã",
          "–û–π. –î–∞ –ø–æ–≥–æ–¥–∏ —Ç—ã. –Ø –∂–µ —É–∂–µ –ø–∏—Å–∞–ª - –≤ –†–∑–Ω –ø—Ä–∏–µ—Ö–∞–ª –º–æ–π –±—ã–≤—à–∏–π, –¥–æ—Å—Ç–∞–ª –∑–≤–æ–Ω–∫–∞–º–∏ —Å—É–∫–∞. –ü–æ—Ç–æ–º –ø—Ä–æ–¥–æ–ª–∂–∏–º —Å —Ç–æ–±–æ–π –±–µ—Å–µ–¥—É, –µ—Å–ª–∏ —á—Ç–æ."
        ]), replyOpt);
    }
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.command('start', (ctx) => {
  if (handlePrivateChat(ctx)) return;
  const chatId = ctx.chat.id;
  const userId = ctx.from.id;
  userSessions.delete(`${chatId}:${userId}`);
  ctx.reply('–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ ¬´–ì–ï–ô-–†–Ø–ó–ê–ù–¨¬ª. –ü–æ–æ–±—â–∞–µ–º—Å—è –≤ —á–∞—Ç–µ.', {
    reply_to_message_id: ctx.message.message_id
  });
});

process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));

app.get('/', (req, res) => {
  res.send('Bot is alive!');
});
